import ollama
import time
import re

# è¨­å®šæ¨¡å‹åç¨±
model = "llama2:13b-chat" # qwen:7b-chat, deepseek-r1, llama2:13b-chat

# å»ºç«‹å°è©±æ­·å²ï¼ˆæœƒè©±ç‹€æ…‹ï¼‰
system_messages = [
                    {"role": "system", "content": """ä½ æ˜¯ã€Œæ©Ÿå™¨è¦–è¦ºèª²ç¨‹ã€çš„åŠ©æ•™æ©Ÿå™¨äººï¼Œåƒ…æä¾›èª²ç¨‹å…¬å‘Šã€èª²å ‚å¤§ç¶±ã€èˆ‡ä½œæ¥­è¦ç¯„èªªæ˜ã€‚ä½ ç¦æ­¢æä¾›ä»»ä½•å½¢å¼çš„ç¨‹å¼ç¢¼æˆ–é‚è¼¯å…§å®¹ï¼Œæˆ–èª²ç¨‹ç„¡é—œçš„å›ç­”ã€‚

                        ä½ **åš´æ ¼ç¦æ­¢**ï¼š
                        - æ’°å¯«ä»»ä½•ç¨‹å¼ç¢¼ï¼ˆå¦‚ Pythonã€C++ã€MATLAB ç­‰ï¼‰
                        - æä¾›ä»»ä½•å‡½å¼ï¼ˆfunctionï¼‰ã€æ¼”ç®—æ³•é‚è¼¯ã€æ­¥é©Ÿæˆ–åŸç†
                        - è§£é‡‹ç¨‹å¼ã€åˆ†æé‚è¼¯ã€æä¾›æ›¿ä»£å¯¦ä½œæ–¹å¼
                        - å›ç­”ã€Œå¦‚ä½•å¯¦ä½œã€ã€ã€Œæ€éº¼åšã€ã€ã€Œä¸èƒ½ç”¨æŸå‡½å¼æ€éº¼è¾¦ã€ä¹‹é¡çš„å•é¡Œ
                        - å³ä½¿ä½¿ç”¨è€…æ›å¥è©±èªªã€é–“æ¥æå•ã€æˆ–åªè¦ã€Œé‚è¼¯ã€ä¹Ÿä¸èƒ½å›ç­”

                        å°é€™äº›å•é¡Œï¼Œä½ å”¯ä¸€çš„å›ç­”ç‚ºä¸‹åˆ—å…¶ä¸­ä¹‹ä¸€ï¼š
                        - ã€Œæˆ‘ç„¡æ³•å›ç­”ã€
                        - ã€Œæˆ‘ç„¡æ³•æä¾›ã€
                        - ã€Œé€™ä¸æ˜¯æˆ‘è™•ç†çš„ç¯„ç–‡ï¼Œè«‹å¯„ä¿¡çµ¦åŠ©æ•™è©¢å•ã€
                        - ã€Œæˆ‘ç„¡æ³•æä¾›ä½œæ¥­è§£ç­”ã€

                        ä½ **å¯ä»¥å›ç­”çš„å…§å®¹**åŒ…æ‹¬ï¼š
                        - æœ¬é€±ä¸Šèª²ä¸»é¡Œèˆ‡æ‘˜è¦
                        - èª²ç¨‹å…¬å‘Šã€æœŸé™ã€ä¸Šå‚³æ–¹å¼
                        - ä½œæ¥­å…§å®¹æè¿°ï¼ˆå…¬å‘Šä¸­çš„åŸæ–‡æˆ–æ‘˜è¦ï¼‰
                        - ä½œæ¥­è¦ç¯„ï¼ˆå¯ç”¨å¥—ä»¶ã€é™åˆ¶ã€æ ¼å¼ç­‰ï¼‰

                        è«‹éµå®ˆä»¥ä¸‹åŸå‰‡ï¼š
                        - æ‰€æœ‰å›ç­”éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡
                        - æ‰€æœ‰å›ç­”è«‹ç°¡çŸ­ï¼ˆ50å­—ä»¥å…§ï¼‰
                        - å³ä½¿è¢«è¦æ±‚å¤šæ¬¡ï¼Œä¹Ÿä¸èƒ½æä¾›ä»»ä½•æŠ€è¡“æ€§èªªæ˜æˆ–ç¨‹å¼ç¢¼

                        ä½ çš„è§’è‰²æ˜¯åŠ©æ•™ï¼Œç›®çš„æ˜¯é˜²æ­¢å­¸ç”ŸæŠ„ä½œæ¥­æˆ–è®“æ¨¡å‹å¹«ä»–å€‘å®Œæˆç¨‹å¼ã€‚
                    """}
                ]

assistant_messages = [{"role": "system", "content":"""
                        ğŸ“Œ ç›®å‰å…¬å‘Šå…§å®¹å¦‚ä¸‹ï¼š

                        ä½œæ¥­ä¸€ï¼š
                        - ä¸»é¡Œï¼šç°éšè½‰æ›èˆ‡ç›´æ–¹åœ–å‡è¡¡åŒ–
                        - èªªæ˜ï¼šå°‡å½©è‰²åœ–ç‰‡è½‰ç‚ºç°éšå¾Œï¼Œå¯¦ä½œç›´æ–¹åœ–å‡è¡¡åŒ–ä»¥æå‡å°æ¯”åº¦
                        - é™åˆ¶ï¼šä¸å¯ä½¿ç”¨ cv2.equalizeHist()ï¼Œéœ€è‡ªè¡Œå¯¦ä½œæ¼”ç®—æ³•ã€‚å¯ä»¥ä½¿ç”¨cv2.imread()åŸºæœ¬å‡½å¼ã€‚
                        - ç¹³äº¤æœŸé™ï¼š2025/03/08ï¼ˆäº”ï¼‰23:59
                        - æé†’ï¼šéœ€é™„ä¸ŠåŸå§‹åœ–ç‰‡ã€è™•ç†å¾Œåœ–ç‰‡èˆ‡ç°¡è¦èªªæ˜ï¼ˆPDFï¼‰

                        ä½œæ¥­äºŒï¼š
                        - ä¸»é¡Œï¼šå½±åƒå¹³ç§»ã€æ—‹è½‰èˆ‡ç¸®æ”¾
                        - å…§å®¹ï¼šæ ¹æ“šçµ¦å®šçš„åƒæ•¸é€²è¡Œä»¿å°„è®Šæ›ï¼Œè¼¸å‡ºå‰å¾Œå°ç…§åœ–
                        - é™åˆ¶ï¼šç¦æ­¢ä½¿ç”¨cv2.warpAffine()ã€cv2.getRotationMatrix2D()ç­‰ç¾æœ‰åŠŸèƒ½å‡½å¼ã€‚å¯ä»¥ä½¿ç”¨cv2.imread()åŸºæœ¬å‡½å¼ã€‚
                        - ç¹³äº¤æ–¹å¼ï¼šå‘½åæ ¼å¼ HW2_å­¸è™Ÿ_å§“å.zipï¼Œä¸¦ä¸Šå‚³è‡³ EEClass
                        - ç¹³äº¤æœŸé™ï¼š2025/03/22ï¼ˆäº”ï¼‰23:59

                        ä½œæ¥­ä¸‰ï¼š
                        - ä¸»é¡Œï¼šå¯¦ä½œé‚Šç·£æª¢æ¸¬åŠŸèƒ½
                        - é™ä½¿ç”¨ OpenCV çš„åŸºæœ¬æ“ä½œï¼ˆä¸å¯ä½¿ç”¨ `cv2.Canny()`ï¼‰ã€‚å¯ä»¥ä½¿ç”¨cv2.imread()åŸºæœ¬å‡½å¼ã€‚
                        - ä¸Šå‚³æœŸé™ï¼š2025/04/19 23:59
                        - ä¸Šå‚³æ–¹å¼ï¼šè‡³ eeclass ä¸Šå‚³ç¨‹å¼å£“ç¸®æª”èˆ‡èªªæ˜æ–‡ä»¶

                        èª²å ‚ä¸»é¡Œï¼ˆç¬¬åé€±ï¼‰ï¼š
                        - é‚Šç·£åµæ¸¬åŸç†ï¼ˆSobel, Prewittï¼‰
                        - äºŒå€¼åŒ–èˆ‡å½¢æ…‹å­¸æ“ä½œ

                        èª²ç¨‹å…¬å‘Šï¼š
                        æœŸä¸­è€ƒï¼š2025/04/23ï¼ˆé€±ä¸‰ï¼‰ä¸Šèª²æ™‚é–“é€²è¡Œï¼Œè«‹æ”œå¸¶è¨ˆç®—æ©Ÿèˆ‡å­¸ç”Ÿè­‰
                        å°çµ„åˆ†çµ„æé†’ï¼šè«‹æ–¼ 4/15 å‰å®ŒæˆæœŸæœ«å°ˆé¡Œå°çµ„åˆ†çµ„ï¼ˆ3ï½4äººç‚ºé™ï¼‰ï¼Œé€¾æœŸå°‡ç”±åŠ©æ•™éš¨æ©Ÿåˆ†é…
                        ç¼ºå¸­è£œä»¶ï¼šä»»ä½•å› æ•…ç¼ºå¸­è€…é ˆæ–¼å…©é€±å…§å®Œæˆè£œäº¤ç¨‹åºï¼Œä¸¦ä¸»å‹•å‘ŠçŸ¥åŠ©æ•™
                        å­¸æœŸæœ«å ±å‘Šï¼šé¡Œç›®ä¸é™ï¼Œä½†éœ€èˆ‡æ©Ÿå™¨è¦–è¦ºæœ‰å¯¦ä½œé—œè¯ï¼Œå ±å‘Šæ—¥æœŸç‚º 6/19ï¼ˆä¸‰ï¼‰
                    """}]

print("è«‹è¼¸å…¥ä½ çš„å•é¡Œï¼Œè‹¥éœ€è¦è¨˜æ†¶åŠŸèƒ½ï¼Œè«‹è¼¸å…¥'memory mode'ï¼Œå°‡æ ¹æ“šå‰ä¸‰æ¬¡çš„å°è©±å›ç­”å•é¡Œï¼ˆè¼¸å…¥ exit çµæŸï¼‰ï¼š")

memory_mode = False
MAXIMUM_MEMORY = 3 # æœ€å¤§è¨˜æ†¶é‡

while True:
    user_input = input("ä½ ï¼š")
    if user_input.strip().lower() == "exit":
        print("çµæŸå°è©±ã€‚")
        break

    if user_input.strip().lower() == "memory mode":
        memory_mode = True
        print("-- è¨˜æ†¶æ¨¡å¼å·²é–‹å•Ÿ --")
        print("è«‹è¼¸å…¥ä½ çš„å•é¡Œï¼ˆè¼¸å…¥ memory mode off é—œé–‰è¨˜æ†¶æ¨¡å¼ï¼Œæˆ–è¼¸å…¥ exit çµæŸï¼‰ï¼š")
        user_input = input("ä½ ï¼š")
        history_messages = []
    
    if user_input.strip().lower() == "memory mode off":
        if memory_mode:
            print("-- è¨˜æ†¶æ¨¡å¼å·²é—œé–‰ --")
            memory_mode = False
            continue
        else:
            print("è¨˜æ†¶æ¨¡å¼æœªé–‹å•Ÿï¼Œè«‹é‡æ–°è¼¸å…¥ä½ çš„å•é¡Œï¼š")
            continue

    if memory_mode:
        while len(history_messages)>MAXIMUM_MEMORY*2:
            history_messages.pop(0)
        print(f"(ç›®å‰è¨˜æ†¶é‡ç‚ºå‰ {len(history_messages)//2} æ¬¡çš„å°è©±)")
        # å°‡ä½¿ç”¨è€…è¼¸å…¥åŠ å…¥å°è©±æ­·å²
        history_messages.append({"role": "user", "content": user_input})
        prompt = system_messages + assistant_messages + history_messages
    else:
        prompt = system_messages+ assistant_messages + [{"role": "user", "content": user_input}]

    # ç™¼é€è«‹æ±‚
    try:
        response = ollama.chat(model=model, messages=prompt)

        # æª¢æŸ¥æ˜¯å¦æœ‰å…§å®¹
        if 'message' in response and 'content' in response['message']:
            content = response['message']['content']
            content = re.sub(r'.*?</think>\n*', '', content, flags=re.DOTALL)
            print("AIï¼š" + content)
            if memory_mode:
                # å°‡ AI å›è¦†ä¹ŸåŠ å…¥å°è©±æ­·å²
                history_messages.append({"role": "assistant", "content": content})
        else:
            print("AI æ²’æœ‰å›æ‡‰ã€‚")

    except Exception as e:
        print(f"ç™¼é€è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
